<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>woodwhales-code-generator</title>
    <link rel="stylesheet" th:href="@{/webjars/layui/css/layui.css}" media="all">
    <link rel="stylesheet" th:href="@{/css/mycss.css}" >
</head>
<body>
<div class="layui-container">
    <div class="layui-header">
        <div class="layui-logo">woodwhales-code-generator</div>
    </div>
    <div class="layui-row">
        <fieldset class="layui-elem-field layui-field-title" style="margin-top: 20px;">
            <legend>添加模板配置 - 导航栏配置</legend>
        </fieldset>
    </div>
    <div class="layui-row">
        <a th:href="@{/}" class="layui-btn layui-bg-gray layui-btn layui-btn-xs">返回</a>
    </div>
    <div class="layui-row">
        <form class="layui-form" action="">
            <fieldset class="layui-elem-field layui-field-title" style="margin-top: 20px;">
                <legend>基础配置信息</legend>
            </fieldset>
            <div class="layui-form-item">
                <label class="layui-form-label">菜单配置</label>
                <div class="layui-input-block">
                    <select name="codeNavigationConfigId" lay-verify="required">
                        <option value="">请选择菜单配置</option>
                        <option th:each="codeNavigationConfig : ${codeNavigationConfigs}" th:value="${codeNavigationConfig.id}" th:text="${codeNavigationConfig.configName}"></option>
                    </select>
                </div>
            </div>
            <div class="layui-form-item">
                <label class="layui-form-label">配置名称</label>
                <div class="layui-input-block">
                    <input type="text" name="configName" id="configName" lay-verify="required" autocomplete="off" placeholder="请输入配置名称" class="layui-input">
                </div>
            </div>
            <div class="layui-form-item">
                <label class="layui-form-label">配置备注</label>
                <div class="layui-input-block">
                    <textarea name="description" id="description" placeholder="请输入配置备注" class="layui-textarea"></textarea>
                </div>
            </div>

            <fieldset class="layui-elem-field layui-field-title" style="margin-top: 20px;">
                <legend>列表页配置</legend>
            </fieldset>
            <div class="layui-form-item">
                <label class="layui-form-label">页面名称</label>
                <div class="layui-input-block">
                    <input type="text" name="navName" id="navName" lay-verify="required" autocomplete="off" placeholder="请输入页面名称" class="layui-input" th:value="${tableInfo.comment}">
                </div>
            </div>

            <fieldset class="layui-elem-field layui-field-title" style="margin-top: 20px;">
                <legend>搜索框配置</legend>
            </fieldset>
            <div class="layui-form-item">
                <div class="layui-inline">
                    <label class="layui-form-label">name</label>
                    <div class="layui-input-block">
                        <select name="searchInputName" id="searchInputName" lay-filter="searchInputName-filter">
                            <option value="">请选择搜索框name</option>
                            <option th:each="column : ${tableInfo.columns}" th:value="${column.name}" th:text="${column.dbName}"></option>
                        </select>
                    </div>
                </div>
                <div class="layui-inline">
                    <label class="layui-form-label">id</label>
                    <div class="layui-input-inline">
                        <input type="text" name="searchInputId" id="searchInputId" autocomplete="off" class="layui-input" readonly="readonly">
                    </div>
                </div>
            </div>
            <div class="layui-form-item">
                <div class="layui-inline">
                    <label class="layui-form-label">placeholder</label>
                    <div class="layui-input-inline">
                        <input type="text" name="searchInputPlaceholder" id="searchInputPlaceholder" autocomplete="off" placeholder="请输入搜索框placeholder" class="layui-input">
                    </div>
                </div>
                <div class="layui-inline">
                    <label class="layui-form-label">sort</label>
                    <div class="layui-input-inline">
                        <input type="text" name="searchInputSort" id="searchInputSort" autocomplete="off" placeholder="请输入搜索框sort" class="layui-input">
                    </div>
                </div>
            </div>
            <div class="layui-form-item">
                <label class="layui-form-label">操作</label>
                <div class="layui-input-inline">
                    <button class="layui-btn layui-btn-fluid layui-btn-normal" id="addConfigBtn">添加</button>
                </div>
                <div class="layui-input-inline">
                    <button class="layui-btn layui-btn-fluid layui-btn-warm" id="clearConfigBtn">清空</button>
                </div>
            </div>
            <div id="searchInputDivId">
            </div>
            <fieldset class="layui-elem-field layui-field-title" style="margin-top: 20px;">
                <legend>表格页配置</legend>
            </fieldset>
            <div class="layui-form-item">
                <label class="layui-form-label">表格链接</label>
                <div class="layui-input-block">
                    <input type="text" name="requestUrl" id="requestUrl" autocomplete="off" class="layui-input" th:value="${#strings.unCapitalize(tableInfo.name)}+'/'">
                </div>
            </div>
            <div class="layui-form-item">
                <div class="layui-input-block">
                    <div class="layui-row">
                        <div class="layui-col-md3">变量</div>
                        <div class="layui-col-md3">标题</div>
                        <div class="layui-col-md3">宽度</div>
                        <div class="layui-col-md3">排序</div>
                    </div>
                </div>
                <div class="layui-input-block" th:each="column, columnStat : ${tableInfo.columns}">
                    <div class="layui-row">
                        <div class="layui-col-md3">
                            <input type="checkbox" name="colsField" lay-skin="primary" th:title="${column.name}" th:value="${column.name}">
                        </div>
                        <div class="layui-col-md3">
                            <input type="text" autocomplete="off" th:id="'colsTitle_'+${column.name}" class="layui-input" placeholder="请输入title" th:value="${column.comment}">
                        </div>
                        <div class="layui-col-md3">
                            <input type="text" autocomplete="off" th:id="'colsWidth_'+${column.name}" class="layui-input" placeholder="请输入width">
                        </div>
                        <div class="layui-col-md3">
                            <input type="text" autocomplete="off" th:id="'colsSort_'+${column.name}" class="layui-input" placeholder="请输入sort" th:value="${columnStat.count}">
                        </div>
                    </div>
                </div>
            </div>
            <div class="layui-form-item">
                <div class="layui-input-block">
                    <button type="submit" class="layui-btn" lay-submit="" lay-filter="submitBtn">创建</button>
                    <button type="reset" class="layui-btn layui-btn-primary">重置</button>
                </div>
            </div>
        </form>
    </div>
    <div class="layui-row" style="height: 44px; background-color: #009688; line-height: 44px; color: #FFF; margin-bottom: 30px; border-radius: 2px;">
        &nbsp;&nbsp;&nbsp;&nbsp;© <a href="https://woodwhales.cn/" style="color: #FFF;" target="_blank">woodwhales.cn</a> - woodwhales's blog
    </div>
</div>
</body>
<script th:src="@{/webjars/layui/layui.js}"></script>
<script th:src="@{/webjars/jquery/jquery.min.js}"></script>
<script type="text/javascript" th:inline="none">

    layui.use(['form', 'layer', 'table', 'layedit', 'util'], function(){
        var form = layui.form,
            layer = layui.layer,
            util = layui.util,
            table = layui.table;

        let searchInputArray = new Array();

        form.on('select(searchInputName-filter)', function (data) {
            let searchInputNameValue = data.value;
            $("#searchInputId").val(searchInputNameValue);
            $("#searchInputPlaceholder").val('请输入'+searchInputNameValue);
            return false;
        });

        $('#addConfigBtn').click(function () {
            let searchInputItem = {};

            searchInputItem.name = $('#searchInputName').val();
            searchInputItem.id = $('#searchInputName').val();
            if(searchInputItem.name === '') {
                layer.msg('请选择搜索框name');
                return false;
            }

            searchInputItem.placeholder = $('#searchInputPlaceholder').val();
            searchInputItem.sort = $('#searchInputSort').val();
            searchInputArray.push(searchInputItem);
            showSearchInputDivId(searchInputArray);
            return false;
        });

        window.closeSearchInputTag = function(index) {
            searchInputArray.splice(index, 1);
            showSearchInputDivId(searchInputArray);
        }

        let showSearchInputDivId = function(searchInputArray) {
            let tempArray = new Array();
            $.each(searchInputArray, function(index, item) {
                tempArray.push('<div class="layui-input-block"><div class="tag-class">name='+ item['name'] + ', id=' + item['id'] +
                    ', placeholder=' + item['placeholder'] + ', sort=' + item['sort'] +
                    '&nbsp;<a class="tag-close" onclick=closeSearchInputTag('+index+')>' +
                    '<i class="layui-icon layui-icon-close"></i></a></div></div>');
            });
            $('#searchInputDivId').html(tempArray.join(""));
        }

        $('#clearConfigBtn').click(function () {
            searchInputArray.splice(0, searchInputArray.length);
            return false;
        });

        let postBody = {};
        form.on('submit(submitBtn)', function(data) {
            if(searchInputArray.length == 0) {
                layer.msg("请添加至少一条搜索框配置");
                return false;
            }

            if($('[name="colsField"]:checked').length == 0) {
                layer.msg("请选择至少一条表格页配置");
                return false;
            }

            let listPageConfig = {};
            let navName = data.field.navName;
            let requestUrl = data.field.requestUrl;
            listPageConfig.navName = navName;
            listPageConfig.searchInput = searchInputArray;
            listPageConfig.tableConfig = {};
            listPageConfig.tableConfig.requestUrl = requestUrl;

            let cols = new Array();
            $('[name="colsField"]:checked').each(function() {
                let colsName = $(this).val();
                let colsField = colsName;
                let colsTitle = $('#colsTitle_'+colsName).val();
                let colsWidth = $('#colsWidth_'+colsName).val();
                let colsSort = $('#colsSort_'+colsName).val();
                let colsItem = {};
                colsItem.field = colsField;
                colsItem.title = colsTitle;
                colsItem.width = colsWidth;
                colsItem.sort = colsSort;
                cols.push(colsItem);
            });

            listPageConfig.tableConfig.cols = cols;

            postBody.codeNavigationConfigId = data.field.codeNavigationConfigId
            postBody.configName = data.field.configName;
            postBody.description = data.field.description;
            postBody.listPageConfig = listPageConfig;

            $.ajax({
                url:'/plugin/codeListPageConfig/create/',
                type:'post',
                dataType:'json',
                contentType:"application/json",
                async:true,
                cache:false,
                data:JSON.stringify(postBody),
                success:function(res) {
                    if(res.code === 0) {
                        layer.msg('操作成功', {icon: 1});
                    } else {
                        layer.msg('操作失败，异常原因：' + res.msg, {icon: 5});
                    }
                },
                error:function(res) {
                    layer.msg('网络异常', {icon: 5});
                }
            });

            return false;
        });

    });
</script>
</html>